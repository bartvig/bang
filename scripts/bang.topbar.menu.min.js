/**
 * Creates the top-bar toggle menu.
 */
(function($) {
  "use strict";

  /**
   * Toggle the search form from the top-bar menu.
   *
   * @param Boolean open
   *   If true we want to open the form and link else we want to close it.
   */
  function ddbasic_search(open) {
    if (open) {
      // If the user clicked the active link, close it instead.
      if ($('.topbar-menu .leaf .topbar-link-search').hasClass('active')) {
        $('.topbar-menu .leaf .topbar-link-search').toggleClass('active');
        $('.js-topbar-search').css("display", "none");
      }
      else {
        // Display the element.
        $('.topbar-menu .leaf .topbar-link-search').toggleClass('active');
        $('.js-topbar-search').css("display", "block");
      }
    }
    else {
      $('.topbar-menu .leaf .topbar-link-search').removeClass('active');
      $('.js-topbar-search').css("display", "none");
    }
  }

  /**
   * Toggle the mobile menu from the top-bar menu.
   *
   * @param bool open
   *   If true we want to open the menu and link else we want to close it.
   */
  function ddbasic_mobile_menu(open) {
    var display = (open) ? 'block' : 'none';
    $('.topbar-link-menu .js-topbar-link').css("display", display);
    /*if ($('.js-mobile-user-menu .menu-link').size() > 0) {
      $('.topbar-link-menu .js-topbar-user-account').css('display', display);
    }*/
  }

  /**
   * Toggle the user login form from the top-bar menu.
   *
   * @param bool open
   *   If true we want to open the form and link else we want to close it.
   */
  function ddbasic_user_login(open) {
    if (open) {
      // If the user clicked the active link, close it instead.
      // but collaps only for mobile screen-sizes
      // 768px is a breakpoint defined in/ inherited from ddbasic-theme (sass/configuration/_variables.scss)
      // check there for the reference
      if ( $('.topbar-menu .leaf .topbar-link-user').hasClass('active') && $(window).width() < 768){
        $('.topbar-menu .leaf .topbar-link-user').toggleClass('active');
        $('.js-topbar-user').css("display", "none");
      }
      else {

        // toggle class only for small screen-sizes, keep it always active if larger
        if($(window).width() < 768){
          $('.topbar-menu .leaf .topbar-link-user').toggleClass('active');
        }
        else{
          $('.topbar-menu .leaf .topbar-link-user').addClass('active');
        }
        // Display the element.
        $('.js-topbar-user').css("display", "block");
      }
    }
    else {
      $('.topbar-menu .leaf .topbar-link-user').removeClass('active');
      $('.js-topbar-user').css("display", "none");
    }
  }

  /**
   * Toggle the user menu when logged in
   *
   * @param bool open
   *   If true we want to open the form and link else we want to close it.
   */
  function ddbasic_user_account(open) {
    if (open) {
      // If the user clicked the active link, close it instead.
      if ( $('.topbar-menu .leaf .topbar-link-user-account').hasClass('active') ) {
        $('.topbar-menu .leaf .topbar-link-user-account').toggleClass('active');
        $('.js-mobile-user-menu').css("display", "none");
      }
      else {
        // Display the element.
        $('.topbar-menu .leaf .topbar-link-user-account').toggleClass('active');
        $('.js-mobile-user-menu').css("display", "block");

        // add also the logout-menu-item
        $('.topbar-menu .leaf .topbar-link-signout').css('display','block');
      }
    }
    else {
      $('.topbar-menu .leaf .topbar-link-user-account').removeClass('active');
      $('.js-mobile-user-menu').css("display", "none");
    }
  }

  /**
   * When ready start the magic and handle the menu.
   */
  $(document).ready(function () {
    // Open search as default on front page, close on others.
   // $('.js-topbar-search').css("display", "none");
   // $('.front .js-topbar-search').css("display", "block");

    //Hide user login on load.
    $('.js-topbar-user').css("display", "none");

      //shorten placeholder-text in search-field if screen-size is $small
      if($('.search .form-text').width() <= 480){
          $('.search .form-text').attr('placeholder','Skriv din sÃ¸gning og tryk "enter"');
      }

    // Set active classes on menu.
    $('.leaf .topbar-link-menu').removeClass('active');
    $('.leaf .topbar-link-search').addClass('active');

    // If the search link is clicked toggle mobile menu and show/hide search.
    $('.js-topbar-link.topbar-link-search').on('click touchstart', function(e) {
      ddbasic_search(true);
      ddbasic_user_login(false);
      ddbasic_user_account(false);
      e.preventDefault();
    });

    // If not logged in
    // If the user login is clicked toggle user and show/hide user menu.
    $('.js-topbar-link.topbar-link-user').on('click touchstart', function(e) {
      var open = !$(this).hasClass('active');

      // we want to keep it active and open for large screen-sizes
      if($(window).width() >= 768 && open === false){
        open = true;
      }

      ddbasic_user_login(open);
      ddbasic_mobile_menu(open);
      ddbasic_search(!open);
      e.preventDefault();
    });

    // If logged-in
    // If the user login is clicked toggle user and show/hide user menu.
    $('.js-topbar-link.topbar-link-user-account.default-override').on('click touchstart', function(e) {
      var open = !$(this).hasClass('active');
      ddbasic_user_account(open);
      ddbasic_mobile_menu(open);
      ddbasic_search(!open);
      e.preventDefault();
    });

    /**
     * Add news category menu as sub-menu to news in main menu
     */

    if ($(".sub-menu-wrapper").length > 0) {
      $('.sub-menu-wrapper > .sub-menu').clone().appendTo('.main-menu > .active-trail');

      // Switch a few classes for style purposes.
      $('.main-menu .sub-menu a').addClass('menu-item');
      $('.main-menu .sub-menu').addClass('main-menu');
      $('.main-menu .sub-menu').removeClass('sub-menu');

      // The old menu is hidden by css on minor media queries.
    }

    /**
     * Adds sub menu above content in Organic groups with OG menu.
     */
    var sub_menu = $(".pane-og-menu-og-single-menu-block");
    if (sub_menu.length) {
      var select = $('<select class="js-og-sub-menu"/>');
      select.addClass('js-og-sub-menu-responsive');

      // Populate drop-down with menu items
      $('a', sub_menu).each(function() {
        var el = $(this);
        $('<option />', {
          "value" : el.attr('href'),
          "text" : el.text(),
          "selected" : el.hasClass('active')
        }).appendTo(select);
      });

      // Detect where to insert the menu. Start with under the library image.
      var target = $('.primary-content .ding-library-image');
      if (!target.length) {
        target = $('.pane-menu-title');
      }

      if (!target.length) {
        // Groups (temaer) pages.
        target = $('.field-name-field-ding-group-title-image');
      }


      if (!target.length) {
        // Static page in OG group and library about page.
        target = $('article.page .page-title');
      }

      // Insert the drop-down if target where found.
      if (target.length) {
        // Attach the menu to the page.
        select.insertAfter(target);

        // Attach "on change" handle to new drop-down menu.
        $(select).change(function () {
          document.location.href = $(this).val();
        });
      }
    }

    // Check if #login fragment is in url.
    var hash = window.location.hash;
    if (hash === "#login") {
      //Show login box.
      ddbasic_user_login(true);
      ddbasic_mobile_menu(false);
      ddbasic_search(false);
    }

    // Figure out if login failed by URL and messaages.
    var url = window.location.toString();
    if (url.indexOf('ding_frontpage') > -1) {
      // Looks like a redirect after a failed login.
      var message = $('.messages');
      if (message.length > 0) {
        // We got messages, positive.
        if (message.hasClass('error')) {
          // And errors. We are guessting the login failed.
          ddbasic_user_login(true);
          ddbasic_mobile_menu(false);
          ddbasic_search(false);
        }
      }
    }
  });
})(jQuery);
